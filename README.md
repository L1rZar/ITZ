За МКАДные ужасы 2

Консольная сюжетная RPG на Python в сеттинге московского метро.  
Игрок проходит линейно‑ветвящуюся историю, сражается с боссами, собирает артефакты и принимает решения, влияющие на сложность боёв и доступные награды.

## Возможности

- Текстовый сюжет по главам (интро + 5 глав, с возможностью продолжить с сохранения).  
- Пошаговые бои «герой vs босс» с простыми скиллами и статус‑эффектами (яд, баф урона, снижение урона врага и т.п.).  
- Система артефактов: временные (расходники) и постоянные (перманентные) артефакты, влияющие на характеристики героя.  
- Терминалы (магазины), где ОЯ (очки ясности) обмениваются на артефакты, включая спец‑терминал с разовыми скидками.  
- Сохранения и загрузка по логину, отдельный JSON‑файл на каждого игрока.

## Структура проекта

```text
.
├── core/          # Логика игры
│   ├── models.py          # Базовые классы Character, ClampedInt
│   ├── heroes.py          # Классы героев и фабрика create_hero
│   ├── enemies.py         # Класс Enemy и фабрика create_boss
│   ├── battle.py          # Боевая система (run_battle)
│   ├── effects.py         # Баффы/дебаффы (add_effect, tick_effects, count_effect)
│   ├── artifacts.py       # Пул артефактов и их эффекты
│   ├── inventory.py       # Простейший инвентарь (аптечки)
│   ├── shops.py           # Терминалы и спец‑терминал
│   ├── save_system.py     # Сохранения в JSON (по логину)
│   ├── auth.py            # Очень простая аутентификация (accounts.txt)
│   ├── text_bank.py       # Все тексты сцен по главам
│   └── utils.py           # Вспомогательные функции (например, wait_enter)
├── scenes/        # Сюжетные сцены
│   ├── intro.py           # Интро и выбор героя
│   ├── chapter_1.py       # Глава 1: Депо №0
│   ├── chapter_2.py       # Глава 2: Архив претензий
│   ├── chapter_3.py       # Глава 3: Лига Безопасности
│   ├── chapter_4.py       # Глава 4: Куратор Перезагрузки
│   └── chapter_5.py       # Глава 5: Протокол Надзора (финал)
├── game/
│   └── main.py    # Точка входа, главное меню, прогон глав
└── data/
    ├── accounts.txt        # Логины и пароли в простом текстовом формате
    ├── artifacts_pool.json # Пул артефактов (перманентных и временных)
    └── players/            # Сохранения игроков (login.json)
```

## Установка и запуск
   ```bash
   python game/main.py
   ```

4. В главном меню:
   - `1` — создать нового пользователя и начать новую игру;  
   - `2` — войти под существующим логином и продолжить с последней главы;  
   - `3` — краткий пересказ пролога (пересказ сюжета 1 части игры из ЛР №2);  
   - `0` — выход из игры.

Сохранения пишутся в `data/players/<login>.json`.  
Пользователи и пароли хранятся в `data/accounts.txt` в формате `login:password`.

## Геймплей и прогресс

### Главы и сохранения

- Интро (`intro.py`) показывает вступление, даёт выбрать героя и выставляет `state["chapter"] = 1`.  
- Каждая глава `chapter_N.py`:
  - Проверяет `state["chapter"]` и не проигрывается повторно, если уже пройдена.  
  - При успешном бою:
    - Начисляет ОЯ (`clarity_points`).  
    - Обновляет `state["chapter"]` на следующую главу.  
    - Сохраняет состояние через `save_system.save_state(state)`.

В `game/main.py` функция `run_game_loop(state)` смотрит на `state["chapter"]` и запускает только те сцены, которые ещё не были пройдены. Например, при `chapter = 2` игра не показывает интро и главу 1 заново.

### Бой

- Бой запускается через `run_battle(state, boss)` из `core/battle.py`.  
- Герой создаётся из `state["hero"]` (имя, HP, ресурс, класс).  
- Перед боем герой получает:
  - Постоянные артефакты из `state["permanent_artifacts"]`.  
  - Артефакты из `state["artifacts"]` (временные и часть постоянных).  
- При `chapter >= 2` перед боем можно дополнительно выбрать один постоянный артефакт из пула.

Доступные действия в бою:

- `1` — обычная атака.  
- `2` — скилл (зависит от класса: воин, лучник, маг, лекарь).  
- `3` — инвентарь (использование аптечки).  
- `4` — артефакты (стимулятор, спрей, тоник и т.п.).

При победе:

- В `state` сохраняются текущие HP/ресурс героя и его артефакты.  
- В инвентарь может добавиться случайный расходуемый артефакт из пула.

При поражении:

- Можно повторить бой (у босса каждый раз снижается максимум HP на 20%).  
- Или отказаться, тогда глава считается проигранной, герой и инвентарь сохраняются, а игрок получает немного ОЯ.

### Артефакты и пул

- Глобальный пул артефактов хранится в `data/artifacts_pool.json`.  
- При загрузке пул автоматически очищается от дублей по `id`, лишние записи не выводятся в консоль.  
- Временные артефакты (`type == "cons"`) дают разовые эффекты:
  - аптечка (+HP);  
  - стимулятор ресурса;  
  - спрей бафа урона;  
  - тоник, снижающий урон врага;  
  - экстренная апелляция, очищающая негатив.

- Постоянные артефакты (`type == "perm"`) могут:
  - повышать максимальное HP и урон;  
  - увеличивать реген ресурса;  
  - давать барьер в начале боя;  
  - усиливать лечение;  
  - уменьшать длительность дебаффов;  
  - давать эффект «ярости» при низком здоровье и другие бонусы.

## Формат сохранений (state)

Состояние игры хранится в JSON примерно такого вида:

```json
{
  "login": "1",
  "chapter": 2,
  "hero": {
    "name": "Саня",
    "max_hp": 140,
    "hp": 40,
    "base_damage": 16,
    "resource_name": "Выносливость",
    "max_res": 10,
    "res": 0,
    "hero_class": "warrior"
  },
  "artifacts": [ ... ],
  "permanent_artifacts": [ ... ],
  "inventory": { "medkit": 0 },
  "clarity_points": 19,
  "flags": {
    "branch": "appeal",
    "special_terminal_used": true
  },
  "chapter_completed": true
}
```

Основные поля:

- `login` — логин игрока (часть имени файла сохранения).  
- `chapter` — номер главы, с которой продолжится игра.  
- `hero` — состояние героя между боями.  
- `artifacts` — текущие артефакты героя (включая временные).  
- `permanent_artifacts` — выданные постоянные артефакты.  
- `inventory` — простые предметы (например, аптечки).  
- `clarity_points` — накопленные ОЯ.  
- `flags` — сюжетные и игровые флаги (ветки, использованные терминалы и т.д.).  

При изменениях формата добавление новых полей делается через `setdefault`, так что старые сохранения остаются рабочими.
